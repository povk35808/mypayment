<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expense Tracker 3D</title>
    
    <!-- Google Fonts: Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Kantumruy Pro', 'sans-serif'],
                    },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.7)',
                        glassBorder: 'rgba(255, 255, 255, 0.5)',
                        primary: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                        }
                    },
                    boxShadow: {
                        '3d': '0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.5) inset',
                        '3d-hover': '0 20px 50px -10px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.6) inset',
                        'soft': '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
                        'glow': '0 0 20px rgba(16, 185, 129, 0.2)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 7s infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'scaleIn': 'scaleIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        pop: {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f0fdfa;
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .glass-input {
            background: rgba(243, 244, 246, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
        }

        .btn-3d {
            background: linear-gradient(145deg, #3A7BD5, #00D2FF);
            box-shadow: 0 4px 15px rgba(58, 123, 213, 0.4);
            transition: all 0.2s;
        }
        .btn-3d:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(58, 123, 213, 0.3);
        }

        .modern-input {
            transition: all 0.3s ease;
        }
        .modern-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            sendEmailVerification,
            updateProfile,
            sendPasswordResetEmail,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getDatabase,
            ref,
            set,
            push,
            onValue,
            remove,
            update,
            get 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDoow-Iiq7KNvWsJ91eWTNxV687yF8cCoI",
            authDomain: "mypayment-382f5.firebaseapp.com",
            projectId: "mypayment-382f5",
            storageBucket: "mypayment-382f5.firebasestorage.app",
            messagingSenderId: "448587219048",
            appId: "1:448587219048:web:9709e0dd0d4cbc42d67bdd",
            measurementId: "G-L7C1E2SQE4",
            databaseURL: "https://mypayment-382f5-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const rawAppId = "default-app-id"; 
        const appId = rawAppId.replace(/[.#$[\]]/g, '_');

        const EXCHANGE_RATE = 4100;
        const CLOUD_NAME = 'ds4z6hf7s';
        const UPLOAD_PRESET = 'mypayment';

        // --- Helpers ---
        const formatMoney = (amount, currency) => {
            const num = parseFloat(amount);
            if (isNaN(num)) return '0.00';
            if (currency === 'USD') {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
            } else {
                return new Intl.NumberFormat('km-KH', { style: 'currency', currency: 'KHR' }).format(num);
            }
        };
        
        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            formData.append('cloud_name', CLOUD_NAME);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                return data.secure_url;
            } catch (error) { console.error("Upload failed", error); throw error; }
        };

        const CATEGORIES = [
            { id: 'food', name: 'អាហារ', icon: 'coffee', color: 'text-orange-500', bg: 'bg-orange-100' },
            { id: 'transport', name: 'ធ្វើដំណើរ', icon: 'car', color: 'text-blue-500', bg: 'bg-blue-100' },
            { id: 'shopping', name: 'ទិញទំនិញ', icon: 'shopping-bag', color: 'text-pink-500', bg: 'bg-pink-100' },
            { id: 'bills', name: 'វិក្កយបត្រ', icon: 'zap', color: 'text-yellow-500', bg: 'bg-yellow-100' },
            { id: 'entertainment', name: 'កម្សាន្ត', icon: 'gamepad-2', color: 'text-purple-500', bg: 'bg-purple-100' },
            { id: 'health', name: 'សុខភាព', icon: 'heart-pulse', color: 'text-rose-500', bg: 'bg-rose-100' },
            { id: 'other', name: 'ផ្សេងៗ', icon: 'pen-tool', color: 'text-gray-500', bg: 'bg-gray-100' },
        ];

        // --- Components ---
        const Icon = ({ name, className }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                const loadIcon = () => {
                    if (window.lucide && window.lucide.icons && window.lucide.createElement) {
                        const iconKey = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                        const iconNode = window.lucide.icons[iconKey];
                        if (iconNode) {
                            const element = window.lucide.createElement(iconNode);
                            element.setAttribute('class', className);
                            setSvgHtml(element.outerHTML);
                        }
                    } else setTimeout(loadIcon, 50);
                };
                loadIcon();
            }, [name, className]);
            return <span style={{ display: 'contents' }} dangerouslySetInnerHTML={{ __html: svgHtml }} />;
        };

        // --- Custom Confirm Modal ---
        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, type = 'danger' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="bg-white rounded-[2rem] p-6 w-full max-w-xs relative z-10 shadow-2xl animate-scaleIn border border-white/50">
                        <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg ${type === 'danger' ? 'bg-red-50 text-red-500 shadow-red-100' : 'bg-blue-50 text-blue-500 shadow-blue-100'}`}>
                            <Icon name={type === 'danger' ? 'alert-triangle' : 'info'} className="w-8 h-8" />
                        </div>
                        <h3 className="text-xl font-bold text-slate-800 mb-2 text-center">{title}</h3>
                        <p className="text-slate-500 text-sm mb-6 text-center leading-relaxed">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-colors">បោះបង់</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className={`flex-1 py-3 rounded-xl text-white font-bold transition-colors shadow-lg active:scale-95 ${type === 'danger' ? 'bg-red-500 hover:bg-red-600 shadow-red-500/30' : 'bg-blue-500 hover:bg-blue-600 shadow-blue-500/30'}`}>
                                {type === 'danger' ? 'យល់ព្រម' : 'Yes'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Component ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState(null);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u) { setLoading(false); setUserProfile(null); }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (user) {
                    const unsub = onValue(ref(db, `artifacts/${appId}/users/${user.uid}/profile`), (snapshot) => {
                        setUserProfile(snapshot.val());
                        setLoading(false);
                    });
                    return () => unsub();
                }
            }, [user]);

            if (loading) return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900">
                    <div className="relative">
                        <div className="w-20 h-20 rounded-full border-4 border-blue-500/30 animate-ping absolute"></div>
                        <div className="w-20 h-20 rounded-full border-4 border-blue-500 border-t-transparent animate-spin relative z-10"></div>
                    </div>
                </div>
            );

            if (user && userProfile?.status === 'frozen') return <FrozenScreen />;
            return user ? <Dashboard user={user} userProfile={userProfile} /> : <AuthScreen />;
        };

        // --- Auth Screen ---
        const AuthScreen = () => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');
            const [showPass, setShowPass] = useState(false);
            const [showConfirmPass, setShowConfirmPass] = useState(false);
            const [imagePreview, setImagePreview] = useState(null);
            const [profileImage, setProfileImage] = useState(null);
            const fileInputRef = useRef(null);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setProfileImage(file);
                    const reader = new FileReader();
                    reader.onloadend = () => setImagePreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); setMsg('');
                if (isRegister && password !== confirmPassword) return setError("ពាក្យសម្ងាត់មិនត្រូវគ្នាទេ");
                setLoading(true);
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    if (isRegister) {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        let photoURL = "";
                        if (profileImage) photoURL = await uploadToCloudinary(profileImage);
                        await updateProfile(cred.user, { displayName: name, photoURL });
                        
                        const snap = await get(ref(db, `artifacts/${appId}/users`));
                        const role = (!snap.exists()) ? 'admin' : 'user';

                        await set(ref(db, `artifacts/${appId}/users/${cred.user.uid}/profile`), {
                            displayName: name, email, uid: cred.user.uid, role, status: 'active', photoURL, createdAt: new Date().toISOString()
                        });
                        await sendEmailVerification(cred.user);
                        setMsg(`គណនីបានបង្កើតជា ${role.toUpperCase()}!`);
                        setIsRegister(false); setEmail(''); setPassword(''); setName(''); setImagePreview(null);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) { setError(err.message.includes('auth') ? "អ៊ីមែល ឬ ពាក្យសម្ងាត់មិនត្រឹមត្រូវ" : err.message); }
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute top-0 -left-4 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-2xl opacity-40 animate-blob"></div>
                    <div className="absolute top-0 -right-4 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply filter blur-2xl opacity-40 animate-blob animation-delay-2000"></div>
                    <div className="absolute -bottom-8 left-20 w-72 h-72 bg-pink-500 rounded-full mix-blend-multiply filter blur-2xl opacity-40 animate-blob animation-delay-4000"></div>

                    <div className="glass-panel w-full max-w-sm rounded-3xl shadow-3d relative z-10 animate-pop overflow-hidden">
                        <div className="p-8 text-center">
                            {isRegister ? (
                                <div onClick={() => fileInputRef.current.click()} className="mx-auto w-24 h-24 relative cursor-pointer group mb-4">
                                    <div className="w-full h-full rounded-full bg-white/50 border-4 border-white shadow-lg overflow-hidden flex items-center justify-center transition-transform group-hover:scale-105">
                                        {imagePreview ? <img src={imagePreview} className="w-full h-full object-cover" /> : <Icon name="camera" className="w-10 h-10 text-gray-400" />}
                                    </div>
                                    <div className="absolute bottom-0 right-0 bg-blue-500 p-2 rounded-full text-white shadow-md"><Icon name="upload" className="w-4 h-4" /></div>
                                    <input type="file" ref={fileInputRef} onChange={handleImageChange} accept="image/*" style={{display:'none'}} />
                                </div>
                            ) : (
                                <div className="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-400 to-purple-600 rounded-3xl rotate-12 flex items-center justify-center shadow-lg animate-float">
                                    <Icon name="wallet" className="w-12 h-12 text-white -rotate-12" />
                                </div>
                            )}
                            <h2 className="text-3xl font-bold text-gray-800 mb-1">{isRegister ? 'បង្កើតគណនី' : 'សូមស្វាគមន៍'}</h2>
                            <p className="text-gray-500 text-sm">{isRegister ? 'ចាប់ផ្តើមដំណើរហិរញ្ញវត្ថុរបស់អ្នក' : 'គ្រប់គ្រងចំណូលចំណាយរបស់អ្នក'}</p>
                        </div>

                        <div className="px-8 pb-8">
                            {error && <div className="mb-4 p-3 bg-red-100/80 border-l-4 border-red-500 text-red-700 text-xs rounded-r-lg font-medium flex items-center gap-2"><Icon name="alert-circle" className="w-4 h-4"/>{error}</div>}
                            {msg && <div className="mb-4 p-3 bg-green-100/80 border-l-4 border-green-500 text-green-700 text-xs rounded-r-lg font-medium flex items-center gap-2"><Icon name="check-circle" className="w-4 h-4"/>{msg}</div>}

                            <form onSubmit={handleSubmit} className="space-y-4">
                                {isRegister && (
                                    <div className="relative group">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-focus-within:text-blue-500"><Icon name="user" className="w-5 h-5"/></div>
                                        <input type="text" required className="glass-input w-full pl-10 pr-4 py-3.5 rounded-xl text-sm outline-none placeholder-gray-400 font-medium text-gray-700" placeholder="ឈ្មោះរបស់អ្នក" value={name} onChange={e=>setName(e.target.value)} />
                                    </div>
                                )}
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-focus-within:text-blue-500"><Icon name="mail" className="w-5 h-5"/></div>
                                    <input type="email" required className="glass-input w-full pl-10 pr-4 py-3.5 rounded-xl text-sm outline-none placeholder-gray-400 font-medium text-gray-700" placeholder="example@email.com" value={email} onChange={e=>setEmail(e.target.value)} />
                                </div>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-focus-within:text-blue-500"><Icon name="lock" className="w-5 h-5"/></div>
                                    <input type={showPass ? "text" : "password"} required className="glass-input w-full pl-10 pr-10 py-3.5 rounded-xl text-sm outline-none placeholder-gray-400 font-medium text-gray-700" placeholder="ពាក្យសម្ងាត់" value={password} onChange={e=>setPassword(e.target.value)} />
                                    <button type="button" onClick={() => setShowPass(!showPass)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-blue-600 transition-colors z-20 cursor-pointer">
                                        <Icon name={showPass ? "eye-off" : "eye"} className="w-5 h-5" />
                                    </button>
                                </div>
                                {isRegister && (
                                    <div className="relative group">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-focus-within:text-blue-500"><Icon name="check-square" className="w-5 h-5"/></div>
                                        <input type={showConfirmPass ? "text" : "password"} required className="glass-input w-full pl-10 pr-10 py-3.5 rounded-xl text-sm outline-none placeholder-gray-400 font-medium text-gray-700" placeholder="បញ្ជាក់ពាក្យសម្ងាត់" value={confirmPassword} onChange={e=>setConfirmPassword(e.target.value)} />
                                        <button type="button" onClick={() => setShowConfirmPass(!showConfirmPass)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-blue-600 transition-colors z-20 cursor-pointer">
                                            <Icon name={showConfirmPass ? "eye-off" : "eye"} className="w-5 h-5" />
                                        </button>
                                    </div>
                                )}

                                <button disabled={loading} className="w-full py-4 btn-3d text-white font-bold rounded-xl mt-6 flex justify-center text-sm uppercase tracking-wide">
                                    {loading ? <div className="w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin"></div> : (isRegister ? 'ចុះឈ្មោះ' : 'ចូលប្រើ')}
                                </button>
                            </form>

                            <div className="mt-6 text-center text-sm text-gray-500">
                                {isRegister ? "មានគណនីរួចហើយ?" : "មិនទាន់មានគណនី?"} 
                                <button onClick={()=>{setIsRegister(!isRegister); setError(''); setMsg('');}} className="ml-1 text-blue-600 font-bold hover:underline">
                                    {isRegister ? 'ចូលប្រើ' : 'បង្កើតថ្មី'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Dashboard (Modern Glass UI) ---
        const Dashboard = ({ user, userProfile }) => {
            const [view, setView] = useState('home');
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editItem, setEditItem] = useState(null); 
            // Modal State
            const [modal, setModal] = useState({ show: false, title: '', message: '', type: 'danger', action: null });
            
            const isAdmin = userProfile?.role === 'admin';

            useEffect(() => {
                const unsub = onValue(ref(db, `artifacts/${appId}/users/${user.uid}/expenses`), (snapshot) => {
                    const val = snapshot.val();
                    const list = val ? Object.entries(val).map(([k, v]) => ({ id: k, ...v, dateObj: new Date(v.date) })).sort((a,b) => b.dateObj - a.dateObj) : [];
                    setExpenses(list);
                    setLoading(false);
                });
                return () => unsub();
            }, [user]);

            const triggerConfirm = (title, message, action, type='danger') => {
                setModal({ show: true, title, message, action, type });
            };

            const handleDelete = (id) => {
                triggerConfirm('លុបចំណាយ?', 'តើអ្នកពិតជាចង់លុបចំណាយនេះមែនទេ?', async () => {
                    await remove(ref(db, `artifacts/${appId}/users/${user.uid}/expenses/${id}`));
                });
            };

            const handleEditClick = (item) => { setEditItem(item); setView('add'); };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl overflow-hidden flex flex-col relative">
                    <ConfirmModal 
                        isOpen={modal.show} 
                        onClose={() => setModal({...modal, show: false})} 
                        onConfirm={modal.action} 
                        title={modal.title} 
                        message={modal.message} 
                        type={modal.type} 
                    />

                    <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-br from-blue-500 to-purple-600 rounded-b-[40px] z-0"></div>
                    
                    {/* Header */}
                    <div className="px-6 pt-6 pb-2 flex justify-between items-center z-10 text-white">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center border border-white/10 shadow-lg">
                                <Icon name="grid" className="w-5 h-5 text-white" />
                            </div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight">Expense 3D</h1>
                                <p className="text-[10px] opacity-80">{isAdmin ? 'Admin Mode' : 'Standard User'}</p>
                            </div>
                        </div>
                        <div onClick={() => setView('profile')} className="w-10 h-10 rounded-full border-2 border-white/30 cursor-pointer overflow-hidden shadow-lg hover:scale-105 transition-transform">
                            <img src={userProfile?.photoURL || 'https://via.placeholder.com/150'} className="w-full h-full object-cover" />
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-y-auto hide-scrollbar z-10 px-5 pt-2 pb-24">
                        {view === 'home' && <HomeView expenses={expenses} onDelete={handleDelete} onEdit={handleEditClick} loading={loading} setView={setView} />}
                        {view === 'add' && <AddEditView user={user} setView={setView} editItem={editItem} setEditItem={setEditItem} />}
                        {view === 'reports' && <ReportsView expenses={expenses} />}
                        {view === 'admin' && isAdmin && <AdminPanel triggerConfirm={triggerConfirm} />}
                        {view === 'profile' && <ProfileSettings user={user} userProfile={userProfile} triggerConfirm={triggerConfirm} />}
                    </div>

                    {/* 3D Floating Bottom Nav */}
                    <div className="absolute bottom-6 left-5 right-5 h-16 glass-panel rounded-2xl flex justify-between items-center px-6 shadow-3d z-30">
                        <NavBtn active={view==='home'} icon="home" onClick={()=>{setView('home'); setEditItem(null);}} />
                        <button onClick={()=>{setEditItem(null); setView('add');}} className="w-14 h-14 bg-gradient-to-tr from-blue-500 to-cyan-400 rounded-full shadow-lg shadow-blue-500/40 text-white flex items-center justify-center -translate-y-6 border-4 border-[#f0f2f5] hover:scale-110 transition-transform">
                            <Icon name="plus" className="w-7 h-7" />
                        </button>
                        {isAdmin ? <NavBtn active={view==='admin'} icon="shield" onClick={()=>{setView('admin'); setEditItem(null);}} /> : <NavBtn active={view==='reports'} icon="pie-chart" onClick={()=>{setView('reports'); setEditItem(null);}} />}
                    </div>
                </div>
            );
        };

        // --- Improved Profile Settings ---
        const ProfileSettings = ({ user, userProfile, triggerConfirm }) => {
            const [loading, setLoading] = useState(false);
            const fileRef = useRef(null);

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                triggerConfirm('ប្តូររូបភាព?', 'តើអ្នកចង់ប្តូររូបភាព Profile មែនទេ?', async () => {
                    setLoading(true);
                    try {
                        const url = await uploadToCloudinary(file);
                        await updateProfile(user, { photoURL: url });
                        await update(ref(db, `artifacts/${appId}/users/${user.uid}/profile`), { photoURL: url });
                    } catch (err) { alert("បរាជ័យ៖ " + err.message); } finally { setLoading(false); }
                }, 'info');
            };

            const confirmLogout = () => {
                triggerConfirm('ចាកចេញ?', 'តើអ្នកពិតជាចង់ចាកចេញពីគណនីនេះមែនទេ?', () => signOut(auth));
            };

            return (
                <div className="animate-pop pb-20 px-2 pt-16">
                    <div className="bg-white rounded-[2.5rem] shadow-xl p-6 relative mt-12 text-center border border-slate-50">
                        {/* Avatar */}
                        <div className="absolute -top-16 left-1/2 -translate-x-1/2">
                            <div className="relative group cursor-pointer" onClick={() => !loading && fileRef.current.click()}>
                                <div className="w-32 h-32 rounded-full border-[6px] border-white shadow-2xl overflow-hidden bg-white relative">
                                    {loading ? (
                                        <div className="absolute inset-0 flex items-center justify-center bg-slate-100"><div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div>
                                    ) : (
                                        <img src={userProfile?.photoURL || 'https://via.placeholder.com/150'} className="w-full h-full object-cover" />
                                    )}
                                </div>
                                <div className="absolute bottom-2 right-2 bg-blue-500 p-2.5 rounded-full text-white border-4 border-white shadow-md hover:scale-110 transition-transform">
                                    <Icon name="camera" className="w-4 h-4" />
                                </div>
                            </div>
                            <input type="file" ref={fileRef} onChange={handleUpload} accept="image/*" style={{display: 'none'}} />
                        </div>
                        
                        <div className="mt-16">
                            <h2 className="text-2xl font-bold text-slate-800 mb-1">{userProfile?.displayName || 'User'}</h2>
                            <p className="text-slate-500 font-medium text-sm mb-6 bg-slate-50 px-3 py-1 rounded-full inline-block">{userProfile?.email}</p>
                            
                            <div className="grid grid-cols-2 gap-3 mb-8">
                                <div className="p-3 bg-slate-50 rounded-2xl border border-slate-100 flex flex-col items-center">
                                    <span className="text-xs text-slate-400 font-bold uppercase mb-1">តួនាទី</span>
                                    <div className={`flex items-center gap-1.5 font-bold ${userProfile?.role === 'admin' ? 'text-indigo-600' : 'text-slate-700'}`}>
                                        <Icon name="shield" className="w-4 h-4" />
                                        {userProfile?.role === 'admin' ? 'Admin' : 'User'}
                                    </div>
                                </div>
                                <div className="p-3 bg-slate-50 rounded-2xl border border-slate-100 flex flex-col items-center">
                                    <span className="text-xs text-slate-400 font-bold uppercase mb-1">ស្ថានភាព</span>
                                    <div className={`flex items-center gap-1.5 font-bold ${userProfile?.status === 'frozen' ? 'text-red-500' : 'text-emerald-600'}`}>
                                        <Icon name="activity" className="w-4 h-4" />
                                        {userProfile?.status === 'frozen' ? 'Frozen' : 'Active'}
                                    </div>
                                </div>
                            </div>

                            <button onClick={confirmLogout} className="w-full py-4 rounded-2xl bg-red-50 text-red-500 font-bold flex items-center justify-center gap-2 hover:bg-red-100 transition-all active:scale-95 border border-red-100 shadow-sm">
                                <Icon name="log-out" className="w-5 h-5" />
                                ចាកចេញពីគណនី
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Other Views ---
        const HomeView = ({ expenses, onDelete, onEdit, loading, setView }) => {
            const totalUSD = useMemo(() => expenses.reduce((acc, c) => acc + (parseFloat(c.amount)||0) / (c.currency==='USD'?1:EXCHANGE_RATE), 0), [expenses]);
            const totalKHR = totalUSD * EXCHANGE_RATE;

            return (
                <div className="space-y-6 animate-pop">
                    <div className="w-full h-48 rounded-[30px] p-6 relative overflow-hidden shadow-3d-hover transition-transform hover:scale-[1.02] duration-300">
                        <div className="absolute inset-0 bg-gradient-to-br from-white/40 to-white/10 backdrop-blur-xl border border-white/30 z-0"></div>
                        <div className="absolute top-0 right-0 w-32 h-32 bg-purple-400 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob"></div>
                        <div className="absolute bottom-0 left-0 w-32 h-32 bg-blue-400 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-2000"></div>
                        
                        <div className="relative z-10 flex flex-col justify-between h-full text-white">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="text-xs font-medium text-white/80 uppercase tracking-wider">សាច់ប្រាក់សរុប</p>
                                    <h2 className="text-3xl font-bold mt-1 drop-shadow-sm">{formatMoney(totalKHR, 'KHR')}</h2>
                                </div>
                                <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><Icon name="credit-card" className="w-6 h-6"/></div>
                            </div>
                            <div className="flex justify-between items-end">
                                <div className="bg-black/10 px-3 py-1 rounded-lg backdrop-blur-sm border border-white/10">
                                    <span className="text-sm font-medium">≈ {formatMoney(totalUSD, 'USD')}</span>
                                </div>
                                <p className="text-[10px] text-white/70">{new Date().toLocaleDateString('km-KH')}</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div className="flex justify-between items-end mb-4 px-2">
                            <h3 className="text-lg font-bold text-gray-800">ប្រតិបត្តិការថ្មីៗ</h3>
                            <button onClick={()=>setView('reports')} className="text-blue-500 text-xs font-bold hover:underline">មើលទាំងអស់</button>
                        </div>
                        {loading ? <div className="space-y-3">{[1,2].map(i=><div key={i} className="h-20 bg-white rounded-2xl animate-pulse"></div>)}</div> : expenses.length===0 ? <div className="text-center py-10 bg-white/50 rounded-3xl"><p className="text-gray-400 text-sm">គ្មានទិន្នន័យ</p></div> : 
                        <div className="space-y-3">
                            {expenses.slice(0,10).map((item, idx)=>(
                                <div onClick={()=>onEdit(item)} key={item.id} className="bg-white p-4 rounded-2xl shadow-soft flex justify-between items-center cursor-pointer transition-all hover:translate-y-[-2px] hover:shadow-lg animate-pop" style={{animationDelay: `${idx*0.05}s`}}>
                                    <div className="flex items-center gap-4">
                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm ${CATEGORIES.find(c=>c.id===item.category)?.bg} ${CATEGORIES.find(c=>c.id===item.category)?.color}`}>
                                            <Icon name={CATEGORIES.find(c=>c.id===item.category)?.icon||'circle'} className="w-6 h-6" />
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-gray-800 text-sm mb-0.5">{item.title}</h4>
                                            <p className="text-[10px] text-gray-400">{new Date(item.date).toLocaleDateString('km-KH')}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-gray-800">{formatMoney(item.amount, item.currency)}</p>
                                        <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="text-gray-300 hover:text-red-500 p-2 -mr-2"><Icon name="trash-2" className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>}
                    </div>
                </div>
            );
        };

        const AddEditView = ({ user, setView, editItem, setEditItem }) => {
            const [form, setForm] = useState(editItem || { title: '', amount: '', currency: 'KHR', category: 'food', date: new Date().toISOString().split('T')[0] });
            const [saving, setSaving] = useState(false);
            const save = async (e) => {
                e.preventDefault(); if(!form.title || !form.amount) return;
                setSaving(true);
                try {
                    const payload = { ...form, amount: parseFloat(form.amount), updatedAt: new Date().toISOString() };
                    if(editItem) await update(ref(db, `artifacts/${appId}/users/${user.uid}/expenses/${editItem.id}`), payload);
                    else { payload.createdAt = new Date().toISOString(); await set(push(ref(db, `artifacts/${appId}/users/${user.uid}/expenses`)), payload); }
                    setEditItem(null); setView('home');
                } catch(err) { alert(err.message); } finally { setSaving(false); }
            };
            return (
                <div className="animate-pop bg-white rounded-[40px] shadow-3d p-6 mt-10">
                    <div className="flex items-center gap-4 mb-6">
                        <button onClick={()=>{setEditItem(null); setView('home');}} className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200"><Icon name="arrow-left" className="w-5 h-5"/></button>
                        <h2 className="text-xl font-bold text-gray-800">{editItem?'កែប្រែ':'បន្ថែមថ្មី'}</h2>
                    </div>
                    <form onSubmit={save} className="space-y-5">
                        <div className="glass-input p-1 rounded-2xl flex items-center">
                            <div className="p-3 text-gray-400"><Icon name="type" className="w-5 h-5"/></div>
                            <input required value={form.title} onChange={e=>setForm({...form, title: e.target.value})} className="bg-transparent w-full outline-none text-gray-700 font-medium" placeholder="ឈ្មោះចំណាយ (ឧ. កាហ្វេ)" />
                        </div>
                        <div className="flex gap-3">
                            <div className="glass-input p-1 rounded-2xl flex items-center flex-1">
                                <div className="p-3 text-gray-400"><Icon name="dollar-sign" className="w-5 h-5"/></div>
                                <input required type="number" step="0.01" value={form.amount} onChange={e=>setForm({...form, amount: e.target.value})} className="bg-transparent w-full outline-none text-gray-700 font-bold text-lg" placeholder="0.00" />
                            </div>
                            <div className="glass-input p-1 rounded-2xl flex items-center w-28">
                                <select value={form.currency} onChange={e=>setForm({...form, currency: e.target.value})} className="bg-transparent w-full outline-none text-gray-700 font-bold text-center appearance-none">
                                    <option value="KHR">៛ KHR</option>
                                    <option value="USD">$ USD</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-400 ml-2 mb-2 block uppercase">ប្រភេទ</label>
                            <div className="grid grid-cols-4 gap-3">
                                {CATEGORIES.map(c=>(
                                    <button key={c.id} type="button" onClick={()=>setForm({...form, category: c.id})} className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all ${form.category===c.id ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-gray-50 text-gray-400 hover:bg-gray-100'}`}>
                                        <Icon name={c.icon} className="w-6 h-6 mb-1"/>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="glass-input p-1 rounded-2xl flex items-center">
                            <div className="p-3 text-gray-400"><Icon name="calendar" className="w-5 h-5"/></div>
                            <input type="date" required value={form.date} onChange={e=>setForm({...form, date: e.target.value})} className="bg-transparent w-full outline-none text-gray-700 font-medium" />
                        </div>
                        <button type="submit" disabled={saving} className="w-full py-4 btn-3d text-white font-bold rounded-2xl mt-4 flex justify-center items-center gap-2">
                            {saving ? 'កំពុងដំណើរការ...' : <><Icon name="save" className="w-5 h-5"/> រក្សាទុក</>}
                        </button>
                    </form>
                </div>
            );
        };

        const ReportsView = ({ expenses }) => {
            const analysis = useMemo(() => {
                let total = 0; const cats = {};
                expenses.forEach(e => { const v = parseFloat(e.amount)/(e.currency==='USD'?1:EXCHANGE_RATE); total += v; const k = e.category; cats[k] = (cats[k]||0)+v; });
                return { total, cats: Object.entries(cats).map(([k,v])=>({name: CATEGORIES.find(c=>c.id===k)?.name||k, val: v, pct: (v/total)*100})).sort((a,b)=>b.val-a.val) };
            }, [expenses]);
            return (
                <div className="animate-pop bg-white rounded-[40px] shadow-3d p-6 mt-10 min-h-[500px]">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">របាយការណ៍</h2>
                    <div className="bg-blue-50 rounded-3xl p-6 text-center mb-8 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-20 h-20 bg-blue-200 rounded-full blur-xl opacity-50 -mr-6 -mt-6"></div>
                        <p className="text-blue-500 font-bold text-xs uppercase tracking-wider">សរុបចំណាយ</p>
                        <h2 className="text-3xl font-extrabold text-blue-600 mt-2">{formatMoney(analysis.total * EXCHANGE_RATE, 'KHR')}</h2>
                    </div>
                    <div className="space-y-4">
                        {analysis.cats.map((c, i)=>(
                            <div key={i} className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-blue-500 font-bold shadow-inner">{c.pct.toFixed(0)}%</div>
                                <div className="flex-1">
                                    <div className="flex justify-between mb-1">
                                        <span className="font-bold text-gray-700">{c.name}</span>
                                        <span className="text-gray-500 text-sm">{formatMoney(c.val * EXCHANGE_RATE, 'KHR')}</span>
                                    </div>
                                    <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-gradient-to-r from-blue-400 to-cyan-400 rounded-full" style={{width: `${c.pct}%`}}></div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const NavBtn = ({ active, icon, onClick }) => (
            <button onClick={onClick} className={`p-2 transition-all duration-300 ${active ? 'text-blue-600 scale-125' : 'text-gray-400 hover:text-gray-600'}`}>
                <Icon name={icon} className="w-7 h-7" />
            </button>
        );

        const FrozenScreen = () => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-red-50 text-center animate-pop">
                <div className="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6 text-red-500 shadow-lg shadow-red-200"><Icon name="lock" className="w-12 h-12" /></div>
                <h2 className="text-3xl font-bold text-gray-800 mb-2">គណនីត្រូវបានបង្កក!</h2>
                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-8 mt-6">
                    <p className="text-xs text-blue-500 font-bold mb-2">ទំនាក់ទំនងជំនួយ</p>
                    <a href="https://t.me/MMKDaro" target="_blank" className="flex items-center justify-center gap-2 text-blue-700 font-bold hover:underline"><Icon name="send" className="w-4 h-4" /> t.me/MMKDaro</a>
                </div>
                <button onClick={() => signOut(auth)} className="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl">ចាកចេញ</button>
            </div>
        );

        const AdminPanel = ({ triggerConfirm }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                const unsub = onValue(ref(db, `artifacts/${appId}/users`), (snap) => {
                    setUsers(snap.val() ? Object.values(snap.val()).map(u => u.profile).filter(Boolean) : []);
                    setLoading(false);
                });
                return () => unsub();
            }, []);
            
            const toggleStatus = (u) => {
                const action = u.status === 'frozen' ? 'បើកដំណើរការវិញ' : 'បង្កក';
                const type = u.status === 'frozen' ? 'info' : 'danger';
                triggerConfirm(`${action}គណនី?`, `តើអ្នកពិតជាចង់${action}គណនី ${u.displayName} មែនទេ?`, async () => {
                    await update(ref(db, `artifacts/${appId}/users/${u.uid}/profile`), { status: u.status === 'frozen' ? 'active' : 'frozen' });
                }, type);
            };

            return (
                <div className="animate-pop pt-20 px-4 pb-24">
                    <h2 className="text-2xl font-bold text-white mb-6 drop-shadow-md">Admin Panel</h2>
                    <div className="space-y-3">
                        {users.map((u, idx) => (
                            <div key={idx} className="bg-white p-4 rounded-2xl shadow-lg flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`w-3 h-3 rounded-full ${u.status === 'frozen' ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                    <div>
                                        <h4 className="font-bold text-gray-800 text-sm">{u.displayName}</h4>
                                        <p className="text-xs text-gray-400">{u.email}</p>
                                    </div>
                                </div>
                                {u.role !== 'admin' && <button onClick={() => toggleStatus(u)} className="p-2 bg-gray-100 rounded-lg"><Icon name={u.status === 'frozen' ? 'unlock' : 'lock'} className="w-4 h-4 text-gray-600" /></button>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
