<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>កម្មវិធីកត់ត្រាចំណាយ - Expense Tracker</title>
    
    <!-- Google Fonts: Kantumruy Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f0fdf4; /* Green-50 */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .animate-slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .pulse-alert {
            animation: pulse-red 2s infinite;
        }

        /* Hide Scrollbar */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Custom Inputs */
        .custom-input:focus {
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Imports (Simulated for CDN) ---
        const { useState, useEffect, useMemo } = React;
        
        // --- Firebase Modular SDK via CDN ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            sendEmailVerification,
            updateProfile,
            sendPasswordResetEmail,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getDatabase,
            ref,
            set,
            push,
            onValue,
            remove,
            update,
            get // Added 'get' for reading once
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDoow-Iiq7KNvWsJ91eWTNxV687yF8cCoI",
            authDomain: "mypayment-382f5.firebaseapp.com",
            projectId: "mypayment-382f5",
            storageBucket: "mypayment-382f5.firebasestorage.app",
            messagingSenderId: "448587219048",
            appId: "1:448587219048:web:9709e0dd0d4cbc42d67bdd",
            measurementId: "G-L7C1E2SQE4",
            databaseURL: "https://mypayment-382f5-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        const rawAppId = "default-app-id"; 
        const appId = rawAppId.replace(/[.#$[\]]/g, '_');

        // --- Constants ---
        const EXCHANGE_RATE = 4100;

        const formatMoney = (amount, currency) => {
            const num = parseFloat(amount);
            if (isNaN(num)) return '0.00';
            if (currency === 'USD') {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
            } else {
                return new Intl.NumberFormat('km-KH', { style: 'currency', currency: 'KHR' }).format(num);
            }
        };

        const CATEGORIES = [
            { id: 'food', name: 'អាហារ', icon: 'coffee', color: 'bg-orange-100 text-orange-600' },
            { id: 'transport', name: 'ធ្វើដំណើរ', icon: 'car', color: 'bg-blue-100 text-blue-600' },
            { id: 'shopping', name: 'ទិញទំនិញ', icon: 'shopping-bag', color: 'bg-pink-100 text-pink-600' },
            { id: 'bills', name: 'ទឹកភ្លើង/អ៊ីនធឺណិត', icon: 'zap', color: 'bg-yellow-100 text-yellow-600' },
            { id: 'entertainment', name: 'ការកម្សាន្ត', icon: 'gamepad-2', color: 'bg-purple-100 text-purple-600' },
            { id: 'health', name: 'សុខភាព', icon: 'heart-pulse', color: 'bg-green-100 text-green-600' },
            { id: 'other', name: 'ផ្សេងៗ (សរសេរដៃ)', icon: 'pen-tool', color: 'bg-gray-100 text-gray-600' },
        ];

        // --- Icons Component ---
        const Icon = ({ name, className }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        // --- Main App Component ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState(null); // Store role & status

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u) {
                        setLoading(false);
                        setUserProfile(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Real-time listener for User Profile (Status & Role)
            useEffect(() => {
                if (user) {
                    const profileRef = ref(db, `artifacts/${appId}/users/${user.uid}/profile`);
                    const unsub = onValue(profileRef, (snapshot) => {
                        const data = snapshot.val();
                        setUserProfile(data);
                        setLoading(false);
                    });
                    return () => unsub();
                }
            }, [user]);

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-green-50">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>
                    </div>
                );
            }

            // --- BLOCKING LOGIC: If status is 'frozen' ---
            if (user && userProfile && userProfile.status === 'frozen') {
                return <FrozenScreen />;
            }

            return user ? <Dashboard user={user} isAdmin={userProfile?.role === 'admin'} /> : <AuthScreen />;
        };

        // --- Frozen Screen (Blocking UI) ---
        const FrozenScreen = () => {
            return (
                <div className="min-h-screen bg-red-50 flex flex-col items-center justify-center p-6 text-center animate-fade-in">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full border-2 border-red-100">
                        <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 pulse-alert text-red-600">
                            <Icon name="lock" className="w-10 h-10" />
                        </div>
                        <h2 className="text-2xl font-bold text-red-600 mb-2">គណនីត្រូវបានបង្កក!</h2>
                        <p className="text-gray-600 mb-6 text-sm leading-relaxed">
                            គណនីរបស់អ្នកត្រូវបានផ្អាកជាបណ្តោះអាសន្នដោយ Admin។ អ្នកមិនអាចប្រើប្រាស់កម្មវិធីបានទេ។
                        </p>
                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                            <p className="text-xs text-gray-500 mb-1">ទំនាក់ទំនងដើម្បីដោះស្រាយ:</p>
                            <a href="https://t.me/MMKDaro" target="_blank" className="flex items-center justify-center gap-2 text-blue-600 font-bold hover:underline">
                                <Icon name="send" className="w-4 h-4" />
                                t.me/MMKDaro
                            </a>
                        </div>
                        <button onClick={() => signOut(auth)} className="w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-colors">
                            ចាកចេញ (Sign Out)
                        </button>
                    </div>
                </div>
            );
        };

        // --- Auth Screen ---
        const AuthScreen = () => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); setMsg(''); setLoading(true);
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    if (isRegister) {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(cred.user, { displayName: name });
                        
                        // NEW LOGIC: Check if ANY users exist
                        // If users node is empty (or doesn't exist), this is the first user => Admin
                        // Else => User
                        const usersRef = ref(db, `artifacts/${appId}/users`);
                        const snapshot = await get(usersRef);
                        const role = snapshot.exists() ? 'user' : 'admin';

                        // Create Profile with Status & Role
                        await set(ref(db, `artifacts/${appId}/users/${cred.user.uid}/profile`), {
                            displayName: name, 
                            email, 
                            uid: cred.user.uid,
                            role: role, 
                            status: 'active', // Default status is active
                            createdAt: new Date().toISOString()
                        });
                        
                        await sendEmailVerification(cred.user);
                        setMsg(`គណនីត្រូវបានបង្កើតជា ${role === 'admin' ? 'Admin' : 'User'}! សូមពិនិត្យមើល Email របស់អ្នក។`);
                        setIsRegister(false);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let message = err.message;
                    if(message.includes('auth/invalid-credential')) message = "អ៊ីមែល ឬ ពាក្យសម្ងាត់មិនត្រឹមត្រូវ";
                    setError(message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-emerald-600 to-teal-500">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-slide-up">
                        <div className="p-8 text-center bg-emerald-50">
                            <div className="w-16 h-16 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg text-white">
                                <Icon name="wallet" className="w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-bold text-emerald-800">កត់ត្រាចំណាយ</h1>
                            <p className="text-emerald-600 text-sm">គ្រប់គ្រងហិរញ្ញវត្ថុរបស់អ្នក</p>
                        </div>
                        <div className="p-8">
                            {error && <div className="mb-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex gap-2"><Icon name="alert-circle" className="w-4 h-4 mt-0.5"/>{error}</div>}
                            {msg && <div className="mb-4 p-3 bg-green-50 text-green-600 text-sm rounded-lg flex gap-2"><Icon name="check-circle" className="w-4 h-4 mt-0.5"/>{msg}</div>}
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {isRegister && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">ឈ្មោះ (ជាភាសាអង់គ្លេស)</label>
                                        <input type="text" required className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none custom-input" placeholder="Dara Sok" value={name} onChange={e=>setName(e.target.value)} />
                                    </div>
                                )}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">អ៊ីមែល</label>
                                    <input type="email" required className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none custom-input" placeholder="email@example.com" value={email} onChange={e=>setEmail(e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                                    <input type="password" required minLength="6" className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none custom-input" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} />
                                    <div className="mt-2 text-[10px] text-gray-500 italic">
                                        * គណនីដំបូងគេនឹងក្លាយជា Admin ដោយស្វ័យប្រវត្តិ
                                    </div>
                                </div>
                                <button disabled={loading} className="w-full py-4 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition-all active:scale-95 flex justify-center">
                                    {loading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : (isRegister ? 'ចុះឈ្មោះ' : 'ចូលប្រើ')}
                                </button>
                            </form>
                            <div className="mt-6 text-center text-sm text-gray-600">
                                {isRegister ? "មានគណនីរួចហើយ?" : "មិនទាន់មានគណនី?"} 
                                <button onClick={()=>setIsRegister(!isRegister)} className="ml-1 text-emerald-600 font-bold hover:underline">
                                    {isRegister ? 'ចូលប្រើ' : 'បង្កើតថ្មី'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Dashboard ---
        const Dashboard = ({ user, isAdmin }) => {
            const [view, setView] = useState('home');
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editItem, setEditItem] = useState(null); 

            useEffect(() => {
                const dataRef = ref(db, `artifacts/${appId}/users/${user.uid}/expenses`);
                const unsub = onValue(dataRef, (snapshot) => {
                    const val = snapshot.val();
                    if (val) {
                        const list = Object.entries(val).map(([k, v]) => ({
                            id: k, ...v, dateObj: new Date(v.date)
                        }));
                        list.sort((a,b) => b.dateObj - a.dateObj);
                        setExpenses(list);
                    } else {
                        setExpenses([]);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, [user]);

            const handleDelete = async (id) => {
                if(confirm("តើអ្នកពិតជាចង់លុបមែនទេ?")) {
                    await remove(ref(db, `artifacts/${appId}/users/${user.uid}/expenses/${id}`));
                }
            };

            const handleEditClick = (item) => {
                setEditItem(item);
                setView('add');
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 relative shadow-2xl overflow-hidden flex flex-col">
                    {/* Header */}
                    <div className="bg-white px-6 py-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600">
                                <Icon name="wallet" className="w-5 h-5" />
                            </div>
                            <div>
                                <h1 className="font-bold text-gray-800 text-lg leading-tight">ExpenseTracker</h1>
                                {isAdmin && <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">Admin Mode</span>}
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <div onClick={() => signOut(auth)} className="p-2 bg-gray-100 rounded-full cursor-pointer hover:bg-red-50 hover:text-red-500 transition-colors">
                                <Icon name="log-out" className="w-4 h-4" />
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto hide-scrollbar pb-24 p-4">
                        {view === 'home' && <HomeView expenses={expenses} onDelete={handleDelete} onEdit={handleEditClick} loading={loading} setView={setView} />}
                        {view === 'add' && <AddEditView user={user} setView={setView} editItem={editItem} setEditItem={setEditItem} />}
                        {view === 'reports' && <ReportsView expenses={expenses} />}
                        {view === 'admin' && isAdmin && <AdminPanel />}
                    </div>

                    {/* Bottom Nav */}
                    <div className="absolute bottom-0 w-full bg-white border-t border-gray-100 px-6 py-2 flex justify-between items-end pb-safe z-30">
                        <NavBtn active={view==='home'} icon="home" label="ទំព័រដើម" onClick={()=>{setView('home'); setEditItem(null);}} />
                        
                        <button onClick={()=>{setEditItem(null); setView('add');}} className="bg-emerald-600 text-white p-4 rounded-full shadow-lg shadow-emerald-200 transform -translate-y-6 hover:scale-105 transition-all border-4 border-gray-50">
                            <Icon name="plus" className="w-7 h-7" />
                        </button>
                        
                        {isAdmin ? (
                            <NavBtn active={view==='admin'} icon="shield" label="Admin" onClick={()=>{setView('admin'); setEditItem(null);}} />
                        ) : (
                            <NavBtn active={view==='reports'} icon="pie-chart" label="របាយការណ៍" onClick={()=>{setView('reports'); setEditItem(null);}} />
                        )}
                    </div>
                </div>
            );
        };

        // --- Admin Panel Component ---
        const AdminPanel = () => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const usersRef = ref(db, `artifacts/${appId}/users`);
                const unsub = onValue(usersRef, (snapshot) => {
                    const val = snapshot.val();
                    if (val) {
                        const list = Object.values(val).map(u => u.profile).filter(p => p); // Get profiles
                        setUsers(list);
                    } else {
                        setUsers([]);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const toggleStatus = async (targetUser) => {
                const newStatus = targetUser.status === 'frozen' ? 'active' : 'frozen';
                const confirmMsg = newStatus === 'frozen' 
                    ? `តើអ្នកចង់បង្កកគណនី ${targetUser.email} មែនទេ?` 
                    : `ដោះលែងគណនី ${targetUser.email} វិញ?`;
                
                if(confirm(confirmMsg)) {
                    await update(ref(db, `artifacts/${appId}/users/${targetUser.uid}/profile`), {
                        status: newStatus
                    });
                }
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">គ្រប់គ្រងអ្នកប្រើប្រាស់ (Admin)</h2>
                    {loading ? <p className="text-center text-gray-400">កំពុងផ្ទុក...</p> : (
                        <div className="space-y-3">
                            {users.map((u, idx) => (
                                <div key={idx} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-3">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h4 className="font-bold text-gray-800 text-sm">{u.displayName}</h4>
                                            <p className="text-xs text-gray-500">{u.email}</p>
                                            <span className={`text-[10px] px-2 py-0.5 rounded-full mt-1 inline-block font-medium ${u.status === 'frozen' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                                {u.status === 'frozen' ? 'Frozen' : 'Active'}
                                            </span>
                                            {u.role === 'admin' && <span className="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-1 font-bold">Admin</span>}
                                        </div>
                                        {u.role !== 'admin' && (
                                            <button 
                                                onClick={() => toggleStatus(u)}
                                                className={`px-3 py-1.5 rounded-lg text-xs font-bold text-white transition-colors ${u.status === 'frozen' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}
                                            >
                                                {u.status === 'frozen' ? 'បើកវិញ' : 'បង្កក'}
                                            </button>
                                        )}
                                    </div>
                                    <div className="text-[10px] text-gray-400 border-t pt-2">
                                        ID: {u.uid}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const NavBtn = ({ active, icon, label, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 w-16 py-2 transition-colors ${active ? 'text-emerald-600' : 'text-gray-400 hover:text-gray-600'}`}>
                <Icon name={icon} className={`w-6 h-6 ${active ? 'fill-emerald-100' : ''}`} />
                <span className="text-[10px] font-medium">{label}</span>
            </button>
        );

        // --- Sub-Views --- (HomeView, AddEditView, ReportsView are same as before)
        const HomeView = ({ expenses, onDelete, onEdit, loading, setView }) => {
            const totalUSD = useMemo(() => {
                return expenses.reduce((acc, curr) => {
                    const amt = parseFloat(curr.amount) || 0;
                    return acc + (curr.currency === 'USD' ? amt : amt / EXCHANGE_RATE);
                }, 0);
            }, [expenses]);
            
            const totalKHR = totalUSD * EXCHANGE_RATE;

            return (
                <div className="space-y-6 animate-fade-in">
                    {/* Balance Card */}
                    <div className="bg-gradient-to-br from-emerald-600 to-teal-600 rounded-3xl p-6 text-white shadow-xl shadow-emerald-200 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -translate-y-10 translate-x-10"></div>
                        <p className="text-emerald-100 text-xs font-medium mb-1">ចំណាយសរុបខែនេះ</p>
                        <h2 className="text-3xl font-bold mb-1">{formatMoney(totalKHR, 'KHR')}</h2>
                        <p className="text-emerald-100 text-sm opacity-80">≈ {formatMoney(totalUSD, 'USD')}</p>
                        
                        <div className="mt-4 flex gap-2">
                            <div className="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-lg text-xs flex items-center gap-2">
                                <Icon name="calendar" className="w-3 h-3" />
                                <span>{new Date().toLocaleDateString('km-KH', { month: 'long', year: 'numeric' })}</span>
                            </div>
                        </div>
                    </div>

                    {/* Recent List */}
                    <div>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">ប្រតិបត្តិការថ្មីៗ</h3>
                            <button onClick={()=>setView('reports')} className="text-emerald-600 text-xs font-bold hover:underline">មើលទាំងអស់</button>
                        </div>

                        {loading ? (
                            <div className="text-center py-10 text-gray-400 text-sm">កំពុងដំណើរការ...</div>
                        ) : expenses.length === 0 ? (
                            <div className="text-center py-12 border-2 border-dashed border-gray-200 rounded-2xl bg-gray-50">
                                <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                                    <Icon name="clipboard-list" className="w-6 h-6" />
                                </div>
                                <p className="text-gray-500 font-medium">មិនទាន់មានទិន្នន័យ</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {expenses.slice(0, 10).map(item => {
                                    const cat = CATEGORIES.find(c => c.id === item.category) || CATEGORIES[6];
                                    const displayCatName = item.category === 'other' && item.customCategory ? item.customCategory : cat.name;

                                    return (
                                        <div onClick={() => onEdit(item)} key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50 cursor-pointer transition-colors">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${cat.color}`}>
                                                    <Icon name={cat.icon} className="w-5 h-5" />
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-gray-800 text-sm">{item.title}</h4>
                                                    <p className="text-[10px] text-gray-500 flex items-center gap-1">
                                                        <span>{displayCatName}</span> • <span>{new Date(item.date).toLocaleDateString('km-KH')}</span>
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-gray-800 text-sm">{formatMoney(item.amount, item.currency)}</p>
                                                <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="text-red-300 hover:text-red-500 p-1">
                                                    <Icon name="trash-2" className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AddEditView = ({ user, setView, editItem, setEditItem }) => {
            const [title, setTitle] = useState(editItem ? editItem.title : '');
            const [amount, setAmount] = useState(editItem ? editItem.amount : '');
            const [currency, setCurrency] = useState(editItem ? editItem.currency : 'KHR');
            const [category, setCategory] = useState(editItem ? editItem.category : 'food');
            const [customCategory, setCustomCategory] = useState(editItem ? editItem.customCategory : '');
            const [date, setDate] = useState(editItem ? editItem.date : new Date().toISOString().substr(0, 10));
            const [isSaving, setIsSaving] = useState(false);

            const handleSave = async (e) => {
                e.preventDefault();
                if (!title || !amount) return;
                setIsSaving(true);
                try {
                    const payload = {
                        title, 
                        amount: parseFloat(amount), 
                        currency, 
                        category,
                        customCategory: category === 'other' ? customCategory : null,
                        date, 
                        updatedAt: new Date().toISOString()
                    };

                    if (editItem) {
                        const itemRef = ref(db, `artifacts/${appId}/users/${user.uid}/expenses/${editItem.id}`);
                        await update(itemRef, payload);
                    } else {
                        payload.createdAt = new Date().toISOString();
                        const listRef = push(ref(db, `artifacts/${appId}/users/${user.uid}/expenses`));
                        await set(listRef, payload);
                    }
                    setEditItem(null);
                    setView('home');
                } catch (err) {
                    alert("បញ្ហា Database: " + err.message);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="animate-slide-up pb-20">
                    <div className="flex items-center gap-3 mb-6">
                        <button onClick={() => { setEditItem(null); setView('home'); }} className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                            <Icon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="text-xl font-bold text-gray-800">{editItem ? 'កែប្រែចំណាយ' : 'បន្ថែមចំណាយថ្មី'}</h2>
                    </div>

                    <form onSubmit={handleSave} className="space-y-5 bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">ឈ្មោះចំណាយ</label>
                            <input required value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none custom-input font-medium" placeholder="ឧ. កាហ្វេ, អាហារថ្ងៃត្រង់" />
                        </div>

                        <div className="grid grid-cols-5 gap-3">
                            <div className="col-span-3">
                                <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">តម្លៃ</label>
                                <input required type="number" step="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none custom-input font-bold text-lg" placeholder="0.00" />
                            </div>
                            <div className="col-span-2">
                                <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">រូបិយប័ណ្ណ</label>
                                <div className="flex bg-gray-50 p-1 rounded-xl border border-gray-200 h-[50px]">
                                    <button type="button" onClick={() => setCurrency('KHR')} className={`flex-1 rounded-lg text-xs font-bold transition-all ${currency === 'KHR' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-400'}`}>៛</button>
                                    <button type="button" onClick={() => setCurrency('USD')} className={`flex-1 rounded-lg text-xs font-bold transition-all ${currency === 'USD' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-400'}`}>$</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">ប្រភេទ</label>
                            <div className="grid grid-cols-4 gap-2">
                                {CATEGORIES.map(cat => (
                                    <button key={cat.id} type="button" onClick={() => setCategory(cat.id)} className={`flex flex-col items-center justify-center p-2 rounded-xl border transition-all aspect-square ${category === cat.id ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-gray-100 hover:bg-gray-50 text-gray-500'}`}>
                                        <Icon name={cat.icon} className="w-5 h-5 mb-1" />
                                        <span className="text-[9px] text-center leading-tight">{cat.name.split(' ')[0]}</span>
                                    </button>
                                ))}
                            </div>
                            {category === 'other' && (
                                <div className="mt-3 animate-fade-in">
                                    <input value={customCategory} onChange={(e) => setCustomCategory(e.target.value)} className="w-full px-4 py-2 bg-emerald-50 border border-emerald-200 rounded-xl focus:outline-none text-sm text-emerald-800 placeholder-emerald-300" placeholder="សរសេរឈ្មោះប្រភេទនៅទីនេះ..." autoFocus />
                                </div>
                            )}
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">កាលបរិច្ឆេទ</label>
                            <input type="date" required value={date} onChange={(e) => setDate(e.target.value)} className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none custom-input" />
                        </div>

                        <button type="submit" disabled={isSaving} className="w-full py-4 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition-all active:scale-95 mt-4">
                            {isSaving ? 'កំពុងរក្សាទុក...' : (editItem ? 'កែប្រែទិន្នន័យ' : 'រក្សាទុក')}
                        </button>
                    </form>
                </div>
            );
        };

        const ReportsView = ({ expenses }) => {
            const analysis = useMemo(() => {
                const now = new Date();
                const currentMonthIdx = now.getMonth();
                const lastMonthIdx = currentMonthIdx === 0 ? 11 : currentMonthIdx - 1;
                
                let currentMonthTotal = 0;
                let lastMonthTotal = 0;
                const byCategory = {};

                expenses.forEach(e => {
                    const d = new Date(e.date);
                    const amt = parseFloat(e.amount);
                    const val = e.currency === 'USD' ? amt * EXCHANGE_RATE : amt;

                    if (d.getMonth() === currentMonthIdx && d.getFullYear() === now.getFullYear()) {
                        currentMonthTotal += val;
                        const catKey = e.category === 'other' && e.customCategory ? 'ផ្សេងៗ' : (CATEGORIES.find(c=>c.id===e.category)?.name || e.category);
                        byCategory[catKey] = (byCategory[catKey] || 0) + val;
                    } 
                    else if (d.getMonth() === lastMonthIdx && d.getFullYear() === (currentMonthIdx === 0 ? now.getFullYear() - 1 : now.getFullYear())) {
                        lastMonthTotal += val;
                    }
                });

                let percentChange = 0;
                let status = 'same'; 
                if (lastMonthTotal > 0) {
                    percentChange = ((currentMonthTotal - lastMonthTotal) / lastMonthTotal) * 100;
                } else if (currentMonthTotal > 0) {
                    percentChange = 100;
                }

                if (percentChange > 0) status = 'increase';
                if (percentChange < 0) status = 'decrease';

                const catData = Object.entries(byCategory)
                    .map(([name, val]) => ({ name, val, percent: (val/currentMonthTotal)*100 }))
                    .sort((a,b) => b.val - a.val);

                return { currentMonthTotal, lastMonthTotal, percentChange: Math.abs(percentChange).toFixed(1), status, catData };
            }, [expenses]);

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">របាយការណ៍ហិរញ្ញវត្ថុ</h2>

                    {/* Comparison Card */}
                    <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                        <h3 className="text-sm font-bold text-gray-500 uppercase mb-4">ប្រៀបធៀប (ខែនេះ vs ខែមុន)</h3>
                        <div className="flex items-end justify-between">
                            <div>
                                <p className="text-3xl font-bold text-gray-800">{formatMoney(analysis.currentMonthTotal, 'KHR')}</p>
                                <p className="text-xs text-gray-400 mt-1">ខែមុន: {formatMoney(analysis.lastMonthTotal, 'KHR')}</p>
                            </div>
                            <div className={`px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1 ${analysis.status === 'increase' ? 'bg-red-100 text-red-600' : analysis.status === 'decrease' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}`}>
                                <Icon name={analysis.status === 'increase' ? 'trending-up' : analysis.status === 'decrease' ? 'trending-down' : 'minus'} className="w-4 h-4" />
                                <span>{analysis.percentChange}%</span>
                            </div>
                        </div>
                        <p className={`text-xs mt-3 ${analysis.status === 'increase' ? 'text-red-500' : 'text-green-600'}`}>
                            {analysis.status === 'increase' ? 'ចំណាយច្រើនជាងខែមុន' : analysis.status === 'decrease' ? 'សន្សំបានល្អជាងខែមុន' : 'ចំណាយប្រហាក់ប្រហែលខែមុន'}
                        </p>
                    </div>

                    {/* Breakdown */}
                    <div>
                        <h3 className="text-lg font-bold text-gray-800 mb-4">ការវិភាគតាមប្រភេទ</h3>
                        <div className="space-y-4">
                            {analysis.catData.length === 0 ? (
                                <p className="text-center text-gray-400 py-8 text-sm">មិនទាន់មានទិន្នន័យសម្រាប់ខែនេះ</p>
                            ) : analysis.catData.map((cat, idx) => (
                                <div key={idx} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-50">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full bg-emerald-500"></div>
                                            <span className="font-bold text-gray-700 text-sm">{cat.name}</span>
                                        </div>
                                        <span className="font-bold text-gray-900 text-sm">{cat.percent.toFixed(1)}%</span>
                                    </div>
                                    <div className="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                        <div className="h-full bg-emerald-500 rounded-full" style={{ width: `${cat.percent}%` }}></div>
                                    </div>
                                    <p className="text-xs text-right mt-1 text-gray-400">{formatMoney(cat.val, 'KHR')}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
